/**
 * @fileoverview Firestore Security Rules for LabelSync application.
 *
 * Core Philosophy:
 * This ruleset provides basic security for a LabelSync application, focusing on
 * data isolation and preventing unauthorized modifications. It assumes a
 * relatively simple data model with top-level collections for products, labels,
 * command logs, themes, and product label designs.
 *
 * Data Structure:
 * - /products/{productId}: Stores product information, with productId as the document ID.
 * - /labels/{labelId}: Stores label information, with labelId as the document ID.
 *   Contains the productId field, which references the parent product.
 * - /command_logs/{commandLogId}: Stores command logs, with commandLogId as the document ID.
 * - /themes/{themeId}: Stores theme information, with themeId as the document ID.
 * - /product_label_designs/{designLinkId}: Stores product label designs, with designLinkId as the document ID.
 *
 * Key Security Decisions:
 * - Command Logs: Restricted to authenticated users.
 * - Themes: Public read access. Write access should be limited to admin roles (unimplemented).
 * - No user-specific data is secured under /users/{userId}.
 * - Data validation is limited to authorization-critical fields (e.g., creatorId, ownership).
 * - List operations are generally allowed for collections without user-specific data.
 *
 * Denormalization for Authorization:
 * - The 'labels' collection contains a 'productId' field. This allows rules to
 *   authorize label access based on the associated product without needing extra 'get()' calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to product information.
     * @path /products/{productId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn(); //TODO: Add validation to check for admin permissions
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages access to label information.
     * @path /labels/{labelId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /labels/{labelId} {
      allow get, list: if true;
      allow create: if isSignedIn(); //TODO: Add validation to check for admin permissions
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages access to command log entries.
     * @path /command_logs/{commandLogId}
     * @allow get: if isSignedIn();
     * @allow list: if isSignedIn();
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Restricts write access to authenticated users for logging purposes.
     */
    match /command_logs/{commandLogId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to theme information.
     * @path /themes/{themeId}
     * @allow get, list: if true;
     * @allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes (unimplemented).
     */
    match /themes/{themeId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages access to product label design links.
     * @path /product_label_designs/{designLinkId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Public read, owner-only writes.
     */
    match /product_label_designs/{designLinkId} {
      allow get, list: if true;
      allow create: if isSignedIn(); //TODO: Add validation to check for admin permissions
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}